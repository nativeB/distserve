let clientToken,localStream,appId="168bb4cac34a49f3b25378cbbfc8dbb7",client=AgoraRTC.createClient({mode:"live",codec:"h264"}),localAudio="usersaudio";function getUserAuthAndToken(){return fetch(`${hadia_live_api}call/make-call`,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({page:page_id,user:user_id,current_page:current_page})}).then(e=>e.json()).catch(e=>e)}function startpusher(){const e={key:"a7808805b311e73d5b87",cluster:"us2",encrypted:!0},n=new Pusher(e.key,e),o=n.subscribe(`customerService-${page_id}`);n.logToConsole=!0,n.connection.bind("error",e=>{4004===e.error.data.code&&log(">>> detected limit error"),log("error",e)}),n.connection.bind("state_change",e=>{log(e.current)}),o.bind(user_id,e=>{console.log(e.channel_name,e.channel_key,e.uid),initializeJoinAndCall(e.channel_name,e.channel_key,e.uid)}),o.bind("offline",e=>{try{endCall()}catch(e){}})}function getUserTokenAndStartCall(){getUserAuthAndToken().then(e=>{e.success&&(mode="calling",main_page_widget.create())}).catch()}function checkSupport(){return AgoraRTC.checkSystemRequirements()}function initializeJoinAndCall(e,n,o){checkSupport()&&(client.init(appId,function(){client.join(n,e,o,function(e){console.log("User "+e+" join channel successfully"),(localStream=AgoraRTC.createStream({streamID:e,audio:!0,video:!1,screen:!1})).init(function(){console.log("getUserMedia successfully"),localStream.play("user"),client.publish(localStream,function(e){console.log("Publish local stream error: "+e)}),client.on("stream-published",function(e){console.log("Publish local stream successfully",e)})},function(e){console.log("getUserMedia failed",e)})},function(e){console.log("Join agents channel failed",e)})},function(e){console.log("AgoraRTC client init failed",e)}),client.on("error",function(e){console.log("Got error msg:",e.reason)}),client.on("stream-subscribed",function(e){e.stream.play("agent"),mode="conversing",main_page_widget.create()}),client.on("stream-added",function(e){let n=e.stream;console.log("New stream added: "+n.getId()),client.subscribe(n,function(e){console.log("Subscribe stream failed",e)})}),client.on("stream-removed",function(e){var n=e.stream;n.stop(),localStream.stop(),console.log("Remote stream is removed "+n.getId())}),client.on("peer-leave",function(e){var n=e.stream;n&&(n.stop(),localStream.stop(),console.log(e.uid+" leaved from this channel"))}))}function endCall(){try{client.leave(()=>{console.log("Leavel channel successfully"),mode="nocall",main_page_widget.create()},function(e){console.log("Leave channel failed")})}catch(e){}}function getDevices(){AgoraRTC.getDevices(function(e){for(var n=0;n!==e.length;++n){var o=e[n],t=document.createElement("option");t.value=o.deviceId,"audioinput"===o.kind?(t.text=o.label||"microphone "+(audioSelect.length+1),audioSelect.appendChild(t)):"videoinput"===o.kind?(t.text=o.label||"camera "+(videoSelect.length+1),videoSelect.appendChild(t)):console.log("Some other kind of source/device: ",o)}})}remoteAudio="agentsaudio",user_id&&startpusher();